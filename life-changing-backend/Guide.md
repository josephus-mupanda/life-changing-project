# **LCEO Backend Project Structure Guide**

## **ğŸ“ Project Overview**

This is the backend API for Life-Changing Endeavor Organization (LCEO), built with **NestJS**. The system manages donors, beneficiaries, programs, donations, and includes USSD integration for offline access.

## **ğŸ—ï¸ Project Structure**

```
life-changing-backend/
â”œâ”€â”€ ğŸ“ docker/           # Docker configuration files
â”œâ”€â”€ ğŸ“ migrations/       # Database migration scripts
â”œâ”€â”€ ğŸ“ scripts/          # Utility and setup scripts
â”œâ”€â”€ ğŸ“ src/
â”‚   â”œâ”€â”€ ğŸ“ config/       # Application configuration
â”‚   â”œâ”€â”€ ğŸ“ common/       # Shared NestJS components
â”‚   â”œâ”€â”€ ğŸ“ shared/       # Reusable utilities and services
â”‚   â””â”€â”€ ğŸ“ modules/      # Feature modules
â”œâ”€â”€ ğŸ“ test/            # Test files
â”œâ”€â”€ ğŸ“„ .env.example     # Environment variables template
â”œâ”€â”€ ğŸ“„ .env            # Actual environment variables (gitignored)
â”œâ”€â”€ ğŸ“„ Dockerfile       # Docker build instructions
â”œâ”€â”€ ğŸ“„ docker-compose.yml # Multi-container setup
â”œâ”€â”€ ğŸ“„ package.json     # Dependencies and scripts
â”œâ”€â”€ ğŸ“„ nest-cli.json    # NestJS CLI configuration
â””â”€â”€ ğŸ“„ tsconfig.json    # TypeScript configuration
```

## **ğŸ”§ Configuration Files**

### **ğŸ“„ .env.example**
**Purpose**: Template for environment variables
**Contains**: All required environment variables with example values
**Usage**: Copy to `.env` and fill with actual values

### **ğŸ“„ .env**
**Purpose**: Actual environment variables (never commit to git!)
**Contains**: Database credentials, API keys, service configurations
**Security**: Contains sensitive data - keep secure

### **ğŸ“„ package.json**
**Purpose**: Project dependencies and scripts
**Key Scripts**:
- `start:dev` - Start development server with hot reload
- `build` - Build for production
- `test` - Run tests
- `migration:run` - Run database migrations
- `docker:up` - Start Docker containers

### **ğŸ“„ nest-cli.json**
**Purpose**: NestJS CLI configuration
**Features**: 
- Auto-generates Swagger documentation
- Configures source roots
- Sets up code generation

### **ğŸ“„ tsconfig.json**
**Purpose**: TypeScript compiler configuration
**Features**:
- Path aliases (`@config/*`, `@modules/*`)
- Strict type checking
- ES2021 target

## **ğŸ³ Docker Configuration**

### **ğŸ“ docker/**
**Purpose**: Docker-related configuration files
**Contains**: 
- Database initialization scripts
- Docker network configurations
- Service health checks

### **ğŸ“„ Dockerfile**
**Purpose**: Instructions to build the application Docker image
**Stages**:
1. **Development stage** - Full build with dev dependencies
2. **Production stage** - Slim image with only production dependencies
**Features**: Multi-stage build for optimized production image

### **ğŸ“„ docker-compose.yml**
**Purpose**: Defines and runs multi-container application
**Services**:
1. **postgres** - PostgreSQL database (port 5432)
2. **redis** - Redis cache and queue (port 6379)
3. **backend** - NestJS application (port 3000)
**Features**: 
- Volume persistence for database
- Network isolation
- Health checks

## **ğŸ—„ï¸ Database Management**

### **ğŸ“ migrations/**
**Purpose**: Database schema migration files
**Generated by**: TypeORM migrations
**Format**: Timestamped files (e.g., `1698765432100-InitialSchema.ts`)
**Usage**: Applied automatically on application start

### **ğŸ“ scripts/**
**Purpose**: Utility scripts for development and deployment
**Key Files**:
1. **`seed-data.ts`** - Populates database with initial test data
2. **`create-initial-migration.ts`** - Creates initial database schema
**Usage**: Run via npm scripts (`npm run seed`, `npm run migration:run`)

## **âš™ï¸ Configuration Module (`src/config/`)**

### **ğŸ“„ configuration.ts**
**Purpose**: Centralized configuration using `@nestjs/config`
**Features**:
- Type-safe environment variables
- Validation with Joi schemas
- Default values for all settings
- Organized by category (database, auth, services)

### **ğŸ“„ database.config.ts**
**Purpose**: TypeORM database configuration
**Features**:
- Connection pooling
- Migration management
- Multiple database support setup
- Production/development mode detection

### **ğŸ“ constants/**
**Purpose**: Application-wide constants and enums
**Contains**:
- User roles and types
- Program categories
- Payment methods
- Notification types
- All system enums

## **ğŸ›¡ï¸ Common Utilities (`src/common/`)**

### **ğŸ“ decorators/**
**Purpose**: Custom NestJS decorators
**Files**:
1. **`roles.decorator.ts`** - Restricts endpoints by user role
2. **`public.decorator.ts`** - Marks endpoints as publicly accessible
**Usage**: Applied to controller methods for access control

### **ğŸ“ guards/**
**Purpose**: Request authentication and authorization guards
**Files**:
1. **`jwt-auth.guard.ts`** - Validates JWT tokens
2. **`roles.guard.ts`** - Enforces role-based access control
**Usage**: Applied globally or per-controller

### **ğŸ“ interceptors/**
**Purpose**: Transform and intercept HTTP responses
**Files**:
1. **`transform.interceptor.ts`** - Standardizes API response format
**Features**: Adds success flag, timestamps, and consistent structure

### **ğŸ“ filters/**
**Purpose**: Global exception handling
**Files**:
1. **`http-exception.filter.ts`** - Handles all HTTP exceptions
**Features**: 
- Consistent error response format
- Logging of all errors
- Production-safe error messages

### **ğŸ“ middleware/**
**Purpose**: Request/response processing middleware
**Files**:
1. **`logging.middleware.ts`** - Logs all HTTP requests
**Features**: 
- Request timing
- Status code logging
- Request/response size

### **ğŸ“ pipes/**
**Purpose**: Request data validation and transformation
**Files**:
1. **`validation.pipe.ts`** - Validates DTOs using class-validator
**Features**: 
- Automatic validation
- Detailed error messages
- Type transformation

## **ğŸ¤ Shared Resources (`src/shared/`)**

### **ğŸ“ database/**
**Purpose**: Database module configuration
**Files**:
1. **`database.module.ts`** - Centralized database module
**Features**: 
- Exports TypeORM for all modules
- Single source of database configuration

### **ğŸ“ services/**
**Purpose**: Reusable service base classes
**Files**:
1. **`base.service.ts`** - Base CRUD service with pagination
**Features**: 
- Standardized pagination
- Common CRUD operations
- Type-safe queries

### **ğŸ“ utils/**
**Purpose**: Utility functions and helpers
**Files**:
1. **`helpers.ts`** - Common utility functions
**Features**:
- Password hashing
- Phone number formatting
- Token generation
- Validation helpers

### **ğŸ“ interfaces/**
**Purpose**: Common TypeScript interfaces
**Files**:
1. **`pagination.interface.ts`** - Standard pagination interfaces
**Features**: 
- Consistent pagination structure
- Type-safe pagination parameters

## **ğŸ“¦ Feature Modules (`src/modules/`)**

Each module follows this structure:
```
module-name/
â”œâ”€â”€ module-name.module.ts    # Module definition
â”œâ”€â”€ module-name.controller.ts # HTTP endpoints
â”œâ”€â”€ module-name.service.ts   # Business logic
â”œâ”€â”€ ğŸ“ entities/             # Database entities
â”œâ”€â”€ ğŸ“ dto/                 # Data transfer objects
â””â”€â”€ ğŸ“ interfaces/          # Module-specific interfaces
```

### **ğŸ” Auth Module**
**Purpose**: Authentication and authorization
**Features**:
- JWT token generation and validation
- Password reset functionality
- Email/phone verification
- Login/registration endpoints

### **ğŸ‘¥ Users Module**
**Purpose**: User management
**Entities**: `User`, `Staff`
**Features**:
- User profile management
- Role-based access control
- Staff management

### **ğŸ‘©â€ğŸ’¼ Beneficiaries Module**
**Purpose**: Beneficiary tracking and management
**Entities**: `Beneficiary`, `WeeklyTracking`, `Goal`, `BeneficiaryDocument`, `EmergencyContact`
**Features**:
- Weekly progress tracking
- Goal setting and tracking
- Document management
- Emergency contacts

### **ğŸ’° Donations Module**
**Purpose**: Donation processing and management
**Entities**: `Donor`, `Donation`, `RecurringDonation`
**Features**:
- One-time and recurring donations
- Multiple payment gateways (Stripe, Mobile Money)
- Receipt generation
- Donor management

### **ğŸ“Š Programs Module**
**Purpose**: Program and project management
**Entities**: `Program`, `Project`, `ImpactMetric`
**Features**:
- Program categorization
- Project hierarchy
- Impact metrics tracking
- Budget management

### **ğŸ“± USSD Module**
**Purpose**: USSD integration for offline access
**Entities**: `UssdSession`
**Features**:
- USSD menu system
- Offline data collection
- SMS notifications
- Africa's Talking integration

### **ğŸ“¨ Notifications Module**
**Purpose**: Notification system
**Entities**: `Notification`
**Features**:
- Multi-channel (SMS, Email, In-app)
- Scheduled notifications
- Delivery tracking
- Template system

### **ğŸ“ Content Module**
**Purpose**: Content management
**Entities**: `Story`
**Features**:
- Success stories
- Multi-language content
- Media management
- Publishing workflow

### **ğŸ“ˆ Analytics Module**
**Purpose**: Data analysis and reporting
**Features**:
- Dashboard widgets
- KPI tracking
- Report generation
- Data visualization

### **âš™ï¸ Admin Module**
**Purpose**: Administration and system management
**Entities**: `ActivityLog`
**Features**:
- Activity logging
- System monitoring
- User management
- Configuration management

### **ğŸ”— Webhooks Module**
**Purpose**: External service integration
**Entities**: `WebhookEvent`
**Features**:
- Webhook processing
- Retry logic
- Event logging
- Signature verification

## **ğŸš€ Application Entry Point**

### **ğŸ“„ main.ts**
**Purpose**: Application bootstrap and configuration
**Features**:
- CORS configuration
- Global middleware setup
- Swagger documentation
- Error handling setup
- Rate limiting

### **ğŸ“„ app.module.ts**
**Purpose**: Root application module
**Features**:
- Imports all feature modules
- Configures global providers
- Sets up task scheduling
- Configures queues

## **ğŸ§ª Testing**

### **ğŸ“ test/**
**Purpose**: Test files and configurations
**Structure**:
- Unit tests alongside source files
- E2E tests in separate folder
- Test utilities and mocks

## **ğŸ” Security Features**

1. **JWT Authentication** - Token-based auth with refresh tokens
2. **Role-Based Access Control** - Fine-grained permissions
3. **Input Validation** - All user inputs validated
4. **SQL Injection Protection** - TypeORM parameterized queries
5. **CORS Configuration** - Restricted to frontend domains
6. **Rate Limiting** - Prevents brute force attacks
7. **Helmet.js** - Security headers
8. **Environment Variables** - No secrets in code

## **ğŸ“Š External Integrations**

1. **Stripe** - Payment processing
2. **Africa's Talking** - SMS/USSD services
3. **SendGrid** - Email delivery
4. **Cloudinary** - File storage
5. **Kobo Toolbox** - Data collection
6. **Redis** - Caching and queues

## **ğŸš¦ Development Workflow**

### **Setup:**
```bash
cp .env.example .env
npm install
npm run docker:up
npm run migration:run
npm run seed
npm run start:dev
```

### **Testing:**
```bash
npm test          # Unit tests
npm run test:e2e  # End-to-end tests
npm run test:cov  # Test coverage
```

### **Production:**
```bash
npm run build
npm run start:prod
# or using PM2:
pm2 start dist/main.js --name lceo-api
```

## **ğŸ“ˆ Monitoring and Logging**

1. **Request Logging** - All HTTP requests logged
2. **Error Tracking** - Structured error logging
3. **Activity Logs** - User actions tracked
4. **Performance Monitoring** - Slow query logging
5. **Health Checks** - System health endpoints

## **ğŸ¯ Key Design Patterns**

1. **Repository Pattern** - Data access abstraction
2. **Service Layer** - Business logic separation
3. **DTO Pattern** - Data validation and transformation
4. **Dependency Injection** - Loose coupling
5. **Modular Architecture** - Feature-based organization
6. **Event-Driven** - Webhooks and notifications

This structure provides a scalable, maintainable foundation for the LCEO platform with clear separation of concerns and production-ready features.